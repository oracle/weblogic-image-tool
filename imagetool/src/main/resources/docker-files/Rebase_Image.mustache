#
# Copyright (c) 2019, 2021, Oracle and/or its affiliates.
#
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.
#
#

{{#isRebaseToTarget}}
FROM {{sourceImage}} as source_image
FROM {{targetImage}} as final_build

ENV DOMAIN_HOME={{{domain_home}}}
LABEL com.oracle.weblogic.imagetool.buildid="{{buildId}}"

{{/isRebaseToTarget}}
{{#isRebaseToNew}}
    FROM {{sourceImage}} as source_image
    FROM {{baseImage}} as os_update

    ENV DOMAIN_HOME={{{domain_home}}}

    LABEL com.oracle.weblogic.imagetool.buildid="{{buildId}}"
    USER root
    {{> package-managers}}

    {{> create-user-group}}

    {{#installJava}}
        # Install Java
        FROM os_update as jdk_build
        LABEL com.oracle.weblogic.imagetool.buildid="{{buildId}}"

        ENV JAVA_HOME={{{java_home}}}

        COPY --chown={{userid}}:{{groupid}} {{java_pkg}} {{{tempDir}}}/

        USER {{userid}}

        {{#beforeJdkInstall}}
            {{{.}}}
        {{/beforeJdkInstall}}

        RUN tar xzf {{{tempDir}}}/{{java_pkg}} -C /u01 \
        && mv /u01/jdk* {{{java_home}}} \
        && rm -rf {{{tempDir}}} \
        && rm -f {{{java_home}}}/javafx-src.zip {{{java_home}}}/src.zip

        {{#afterJdkInstall}}
            {{{.}}}
        {{/afterJdkInstall}}
    {{/installJava}}

    FROM os_update as wls_build
    # Install middleware
    LABEL com.oracle.weblogic.imagetool.buildid="{{buildId}}"

    ENV JAVA_HOME={{{java_home}}} \
        ORACLE_HOME={{{oracle_home}}} \
        OPATCH_NO_FUSER=true

    RUN mkdir -p {{{oracle_home}}} \
    {{#isCustomInventoryLoc}}
        && mkdir -p {{inv_loc}} \
        && chown {{userid}}:{{groupid}} {{inv_loc}} \
    {{/isCustomInventoryLoc}}
    && mkdir -p {{orainv_dir}} \
    && chown {{userid}}:{{groupid}} {{orainv_dir}} \
    && chown {{userid}}:{{groupid}} {{{oracle_home}}}

    {{#installJava}}
        COPY --from=jdk_build --chown={{userid}}:{{groupid}} {{{java_home}}} {{{java_home}}}/
    {{/installJava}}

    {{#installPackages}}COPY --chown={{userid}}:{{groupid}} {{installerFilename}} {{responseFile.name}} {{{tempDir}}}/
    {{/installPackages}}
    COPY --chown={{userid}}:{{groupid}} oraInst.loc {{inv_loc}}/

    USER {{userid}}

    {{#beforeFmwInstall}}
        {{{.}}}
    {{/beforeFmwInstall}}

    RUN echo "INSTALLING MIDDLEWARE" \
    {{#installPackages}}
        && echo "RUNNING {{type}} INSTALLER" \
        && {{#isZip}}unzip -q {{{tempDir}}}/{{installerFilename}} "*.jar" -d {{{tempDir}}} &&{{/isZip}} \
        {{{java_home}}}/bin/java -Xmx1024m -jar {{{tempDir}}}/{{jarName}} -silent ORACLE_HOME={{{oracle_home}}} \
        -responseFile {{{tempDir}}}/{{responseFile.name}} -invPtrLoc {{inv_loc}}/oraInst.loc -ignoreSysPrereqs -force -novalidation \
    {{/installPackages}}
    && chmod -R g+r {{{oracle_home}}}

    {{> fmw-patching}}

    {{#afterFmwInstall}}
        {{{.}}}
    {{/afterFmwInstall}}


    FROM os_update as final_build

    ENV ORACLE_HOME={{{oracle_home}}} \
    {{#installJava}}
        JAVA_HOME={{{java_home}}} \
    {{/installJava}}
    PATH=${PATH}:{{{java_home}}}/bin:{{{oracle_home}}}/oracle_common/common/bin:{{{oracle_home}}}/wlserver/common/bin:{{{oracle_home}}}

    LABEL com.oracle.weblogic.imagetool.buildid="{{buildId}}"

    {{#installJava}}
        COPY --from=jdk_build --chown={{userid}}:{{groupid}} {{{java_home}}} {{{java_home}}}/
    {{/installJava}}

    COPY --from=wls_build --chown={{userid}}:{{groupid}} {{{oracle_home}}} {{{oracle_home}}}/
    {{#copyOraInst}}
        COPY --from=wls_build --chown={{userid}}:{{groupid}} {{inv_loc}}/oraInst.loc  {{inv_loc}}/oraInst.loc
    {{/copyOraInst}}
    {{#copyOraInventoryDir}}
        COPY --from=wls_build --chown={{userid}}:{{groupid}} {{orainv_dir}} {{orainv_dir}}/
    {{/copyOraInventoryDir}}
{{/isRebaseToNew}}

USER {{userid}}
RUN mkdir -p {{domain_home}}
{{^modelOnly}}
    COPY --from=source_image --chown={{userid}}:{{groupid}} {{domain_home}} {{domain_home}}/
{{/modelOnly}}
{{#modelOnly}}
    COPY --from=source_image --chown={{userid}}:{{groupid}} {{{wdt_home}}} {{{wdt_home}}}/
    {{#isWdtModelHomeOutsideWdtHome}}
        COPY --from=wdt_build --chown={{userid}}:{{groupid}} {{wdt_model_home}} {{wdt_model_home}}/
    {{/isWdtModelHomeOutsideWdtHome}}
{{/modelOnly}}

RUN chmod g+w {{{domain_home}}}

WORKDIR {{{work_dir}}}

{{#finalBuildCommands}}
    {{{.}}}
{{/finalBuildCommands}}

