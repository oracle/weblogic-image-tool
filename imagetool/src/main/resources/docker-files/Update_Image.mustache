# Copyright (c) 2019, 2021, Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.
#

{{#isWdtEnabled}}
    {{> run-wdt }}
{{/isWdtEnabled}}

FROM {{baseImage}} as final_build
USER root

ENV OPATCH_NO_FUSER=true

{{#isWdtEnabled}}
ENV  DOMAIN_HOME={{{domain_home}}} \
    {{#modelOnly}}
        WDT_MODEL_HOME={{{wdt_model_home}}} \
    {{/modelOnly}}
    PATH=${PATH}:{{{domain_home}}}/bin
{{/isWdtEnabled}}

LABEL com.oracle.weblogic.imagetool.buildid="{{buildId}}"

USER {{userid}}

{{> fmw-patching}}

{{#isWdtEnabled}}
    {{#modelOnly}}
        RUN DOMAIN_PARENT=$(dirname {{{domain_home}}}) \
        && mkdir -p $DOMAIN_PARENT \
        && chown {{userid}}:{{groupid}} $DOMAIN_PARENT \
        && mkdir -p {{{wdt_model_home}}}
        COPY --from=wdt_build --chown={{userid}}:{{groupid}} {{wdt_home}} {{wdt_home}}/
        {{#isWdtModelHomeOutsideWdtHome}}
            COPY --from=wdt_build --chown={{userid}}:{{groupid}} {{wdt_model_home}} {{wdt_model_home}}/
        {{/isWdtModelHomeOutsideWdtHome}}
        RUN chmod g+w {{{wdt_model_home}}} $DOMAIN_PARENT
    {{/modelOnly}}
    {{^modelOnly}}
        COPY --from=wdt_build --chown={{userid}}:{{groupid}} {{{domain_home}}} {{{domain_home}}}/
        RUN chmod g+w {{{domain_home}}}
    {{/modelOnly}}
{{/isWdtEnabled}}

{{#finalBuildCommands}}
    {{{.}}}
{{/finalBuildCommands}}

